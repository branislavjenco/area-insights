<!DOCTYPE html>
<html>
    <head>
        <title>Multiple WMS Sources in Leaflet</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"
        />
        <script src="https://cdn.jsdelivr.net/npm/@turf/turf@7/turf.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

        <style>
            html,
            body {
                height: 100%;
                margin: 0;
                padding: 0;
            }
            #map {
                position: absolute;
                top: 0;
                bottom: 0;
                width: 100%;
                height: 100%;
            }
            .leaflet-control-layers-list {
                max-height: 500px;
                overflow-y: auto;
            }
            #search-container {
                position: absolute;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 1000;
                display: flex;
                gap: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
                background: white;
                padding: 8px;
                border-radius: 4px;
            }
            #address-input {
                padding: 8px 12px;
                width: 300px;
                border: 1px solid #ccc;
                border-radius: 4px;
                font-size: 14px;
            }
            #search-button {
                padding: 8px 16px;
                background-color: #0078a8;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
            }
            #search-button:hover {
                background-color: #005d85;
            }
        </style>
        <script
            data-goatcounter="https://area-insights.goatcounter.com/count"
            async
            src="//gc.zgo.at/count.js"
        ></script>
    </head>
    <body>
        <div id="search-container">
            <input
                type="text"
                id="address-input"
                placeholder="Enter address..."
            />
            <button id="search-button">Search</button>
        </div>
        <div id="map"></div>

        <script>
            // Initialize the map centered on Norway
            const map = L.map("map").setView([65, 13], 5);
            const desiredLayers = [
                "FlomAktsomhet - Flom_aktsomhetsomrade",
                "SkredKvikkleire2 - KvikkleireRisiko",
                "SkredKvikkleire2 - KvikkleireFaregrad",
                "stoykart strategisk veg - stoy_veg_natt",
                "stoykart strategisk veg - stoy_veg_dogn",
                "stoykart strategisk veg - stoy_veg_storby_natt",
                "stoykart strategisk veg - stoy_veg_storby_dogn",
            ];

            // Add OpenStreetMap as a base layer
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                attribution:
                    '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            }).addTo(map);

            // Function to add the country overlay
            async function addCountryOverlay() {
                try {
                    // Fetch detailed Norway GeoJSON data
                    const response = await fetch(
                        "https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_0_countries.geojson"
                    );
                    const data = await response.json();

                    // Find Norway's boundaries
                    const norway = data.features.find(
                        (feature) =>
                            feature.properties.NAME === "Norway" ||
                            feature.properties.ADMIN === "Norway"
                    );

                    if (norway) {
                        // Create a mask that covers the view area
                        const worldMaskCoordinates = [
                            [
                                [
                                    [-180, 90],
                                    [180, 90],
                                    [180, -90],
                                    [-180, -90],
                                    [-180, 90],
                                ],
                            ],
                        ];

                        // Create a geoJSON feature out of the world coordinates
                        const worldMaskFeature = {
                            type: "Feature",
                            properties: {},
                            geometry: {
                                type: "MultiPolygon",
                                coordinates: worldMaskCoordinates,
                            },
                        };

                        // Create a mask of Norway's geometry
                        const norwayMask = {
                            type: "Feature",
                            properties: {},
                            geometry: norway.geometry,
                        };

                        // Create a combined mask by subtracting the norway mask from the world mask
                        const combinedMask = turf.difference(
                            turf.featureCollection([
                                worldMaskFeature,
                                norwayMask,
                            ])
                        );

                        // Add the mask layer
                        L.geoJSON(combinedMask, {
                            style: {
                                fillColor: "#808080",
                                fillOpacity: 0.2,
                                weight: 0,
                                interactive: false,
                            },
                        }).addTo(map);
                    }
                } catch (error) {
                    console.error("Error loading country data:", error);
                }
            }

            // Call the function to add the country overlay
            addCountryOverlay();

            // Define your WMS URLs
            const wmsUrls = [
                "https://wms.miljodirektoratet.no/arcgis/services/stoy/stoykart_strategisk_veg/MapServer/WMSServer",
                "https://nve.geodataonline.no/arcgis/services/FlomAktsomhet/MapServer/WMSServer",
                "https://nve.geodataonline.no/arcgis/services/SkredKvikkleire2/MapServer/WMSServer",
            ];

            // Store the active layer and current marker
            let activeLayer = null;
            let currentMarker = null;

            // Function to create a WMS layer
            function createWMSLayer(url, layerName) {
                return L.tileLayer.wms(url, {
                    layers: layerName,
                    format: "image/png",
                    transparent: true,
                    version: "1.1.1",
                });
            }

            // Initialize radio base maps object with "None" option
            const radioBaseMaps = {
                None: L.layerGroup([]),
            };

            // Function to process a single WMS service
            async function processWMSService(url) {
                try {
                    const response = await fetch(
                        `${url}?SERVICE=WMS&REQUEST=GetCapabilities&VERSION=1.1.1`
                    );
                    const str = await response.text();
                    const data = new window.DOMParser().parseFromString(
                        str,
                        "text/xml"
                    );

                    // Get service title
                    const serviceTitle =
                        data.querySelector("Service > Title")?.textContent ||
                        url;

                    // Parse available layers
                    const layers = data.getElementsByTagName("Layer");
                    for (const layer of layers) {
                        const nameElement =
                            layer.getElementsByTagName("Name")[0];
                        const titleElement =
                            layer.getElementsByTagName("Title")[0];

                        if (
                            nameElement &&
                            layer.parentNode.tagName === "Layer"
                        ) {
                            const name = nameElement.textContent;
                            const title = titleElement?.textContent || name;
                            const fullTitle = `${serviceTitle} - ${title}`;
                            console.log(fullTitle);
                            radioBaseMaps[fullTitle] = createWMSLayer(
                                url,
                                name
                            );
                        }
                    }
                } catch (error) {
                    console.error(
                        "Error fetching WMS capabilities for",
                        url,
                        ":",
                        error
                    );
                }
            }

            // Geocoding function using Nominatim
            async function geocodeAddress(address) {
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
                    address
                )}`;
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    if (data.length > 0) {
                        const location = data[0];
                        const latlng = [location.lat, location.lon];

                        // Remove previous marker if it exists
                        if (currentMarker) {
                            map.removeLayer(currentMarker);
                        }

                        // Add new marker
                        currentMarker = L.marker(latlng)
                            .addTo(map)
                            .bindPopup(location.display_name)
                            .openPopup();

                        // Set view to new location
                        map.setView(latlng, 16);
                    } else {
                        alert("Address not found");
                    }
                } catch (error) {
                    console.error("Geocoding error:", error);
                    alert("Error searching for address");
                }
            }

            // Set up search functionality
            const searchButton = document.getElementById("search-button");
            const addressInput = document.getElementById("address-input");

            searchButton.addEventListener("click", () => {
                const address = addressInput.value.trim();
                if (address) {
                    geocodeAddress(address);
                }
            });

            addressInput.addEventListener("keypress", (e) => {
                if (e.key === "Enter") {
                    const address = addressInput.value.trim();
                    if (address) {
                        geocodeAddress(address);
                    }
                }
            });

            // Process all WMS services and create layer control after completion
            Promise.all(wmsUrls.map(processWMSService)).then(() => {
                const layerControl = L.control
                    .layers(radioBaseMaps, null, {
                        collapsed: false,
                    })
                    .addTo(map);

                map.on("baselayerchange", function (e) {
                    if (activeLayer && e.layer !== activeLayer) {
                        map.removeLayer(activeLayer);
                    }
                    activeLayer = e.layer;
                });

                const firstLayerName = Object.keys(radioBaseMaps)[1];
                if (firstLayerName) {
                    radioBaseMaps[firstLayerName].addTo(map);
                    activeLayer = radioBaseMaps[firstLayerName];
                }
            });

            // Add a scale control
            L.control.scale().addTo(map);
        </script>
    </body>
</html>
