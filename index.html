<!DOCTYPE html>
<html>
    <head>
        <title>Multiple WMS Sources in Leaflet</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"
        />
        <script src="https://cdn.jsdelivr.net/npm/@turf/turf@7/turf.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

        <style>
            html, body {
                height: 100%;
                margin: 0;
            }
            #map {
                height: 100%;
            }
            #controls {
                position: absolute;
                top: 10px;
                left: 10px;
                right: 10px;
                z-index: 1000;
                background: white;
                padding: 5px;
                display: flex;
                gap: 5px;
                align-items: center;
            }
            #address-input {
                flex: 1;
                min-width: 0;
                padding: 5px;
            }
            .leaflet-control-layers-list {
                max-height: 60vh;
                overflow-y: auto;
            }
            /* Move the layers control into the controls div */
            .leaflet-top.leaflet-right {
                display: none;
            }
            /* Basic styling for the layers control when inside our container */
            #controls .leaflet-control-layers {
                margin: 0;
                border: none;
                padding: 0;
            }
            #controls .leaflet-control-layers-toggle {
                width: 30px;
                height: 30px;
            }
        </style>
        <script
            data-goatcounter="https://area-insights.goatcounter.com/count"
            async
            src="//gc.zgo.at/count.js"
        ></script>
    </head>
    <body>
        <div id="controls">
            <input type="text" id="address-input" placeholder="Enter address..." />
            <button id="search-button">Search</button>
            <!-- Layer control will be moved here by JavaScript -->
        </div>
        <div id="map"></div>

        <script>
            // Initialize the map centered on Norway
            const map = L.map("map").setView([65, 13], 5);
            
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            }).addTo(map);

            async function addCountryOverlay() {
                try {
                    const response = await fetch(
                        "https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_0_countries.geojson"
                    );
                    const data = await response.json();

                    const norway = data.features.find(
                        (feature) =>
                            feature.properties.NAME === "Norway" ||
                            feature.properties.ADMIN === "Norway"
                    );

                    if (norway) {
                        const worldMaskCoordinates = [
                            [
                                [
                                    [-180, 90],
                                    [180, 90],
                                    [180, -90],
                                    [-180, -90],
                                    [-180, 90],
                                ],
                            ],
                        ];

                        const worldMaskFeature = {
                            type: "Feature",
                            properties: {},
                            geometry: {
                                type: "MultiPolygon",
                                coordinates: worldMaskCoordinates,
                            },
                        };

                        const norwayMask = {
                            type: "Feature",
                            properties: {},
                            geometry: norway.geometry,
                        };

                        const combinedMask = turf.difference(
                            turf.featureCollection([
                                worldMaskFeature,
                                norwayMask,
                            ])
                        );

                        L.geoJSON(combinedMask, {
                            style: {
                                fillColor: "#808080",
                                fillOpacity: 0.2,
                                weight: 0,
                                interactive: false,
                            },
                        }).addTo(map);
                    }
                } catch (error) {
                    console.error("Error loading country data:", error);
                }
            }

            addCountryOverlay();

            const wmsUrls = [
                "https://wms.miljodirektoratet.no/arcgis/services/stoy/stoykart_strategisk_veg/MapServer/WMSServer",
                "https://nve.geodataonline.no/arcgis/services/FlomAktsomhet/MapServer/WMSServer",
                "https://nve.geodataonline.no/arcgis/services/SkredKvikkleire2/MapServer/WMSServer",
            ];

            let activeLayer = null;
            let currentMarker = null;

            function createWMSLayer(url, layerName) {
                return L.tileLayer.wms(url, {
                    layers: layerName,
                    format: "image/png",
                    transparent: true,
                    version: "1.1.1",
                });
            }

            const radioBaseMaps = {
                None: L.layerGroup([]),
            };

            async function processWMSService(url) {
                try {
                    const response = await fetch(
                        `${url}?SERVICE=WMS&REQUEST=GetCapabilities&VERSION=1.1.1`
                    );
                    const str = await response.text();
                    const data = new window.DOMParser().parseFromString(
                        str,
                        "text/xml"
                    );

                    const serviceTitle =
                        data.querySelector("Service > Title")?.textContent ||
                        url;

                    const layers = data.getElementsByTagName("Layer");
                    for (const layer of layers) {
                        const nameElement =
                            layer.getElementsByTagName("Name")[0];
                        const titleElement =
                            layer.getElementsByTagName("Title")[0];

                        if (
                            nameElement &&
                            layer.parentNode.tagName === "Layer"
                        ) {
                            const name = nameElement.textContent;
                            const title = titleElement?.textContent || name;
                            const fullTitle = `${serviceTitle} - ${title}`;
                            console.log(fullTitle);
                            radioBaseMaps[fullTitle] = createWMSLayer(
                                url,
                                name
                            );
                        }
                    }
                } catch (error) {
                    console.error(
                        "Error fetching WMS capabilities for",
                        url,
                        ":",
                        error
                    );
                }
            }

            async function geocodeAddress(address) {
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
                    address
                )}`;
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    if (data.length > 0) {
                        const location = data[0];
                        const latlng = [location.lat, location.lon];

                        if (currentMarker) {
                            map.removeLayer(currentMarker);
                        }

                        currentMarker = L.marker(latlng)
                            .addTo(map)
                            .bindPopup(location.display_name)
                            .openPopup();

                        map.setView(latlng, 16);
                    } else {
                        alert("Address not found");
                    }
                } catch (error) {
                    console.error("Geocoding error:", error);
                    alert("Error searching for address");
                }
            }

            const searchButton = document.getElementById("search-button");
            const addressInput = document.getElementById("address-input");

            searchButton.addEventListener("click", () => {
                const address = addressInput.value.trim();
                if (address) {
                    geocodeAddress(address);
                }
            });

            addressInput.addEventListener("keypress", (e) => {
                if (e.key === "Enter") {
                    const address = addressInput.value.trim();
                    if (address) {
                        geocodeAddress(address);
                    }
                }
            });

            Promise.all(wmsUrls.map(processWMSService)).then(() => {
                const layerControl = L.control
                    .layers(radioBaseMaps, null, {
                        collapsed: true
                    })
                    .addTo(map);
                
                // Move the layer control into our custom controls container
                const controlsContainer = document.getElementById('controls');
                const layerControlContainer = document.querySelector('.leaflet-control-layers');
                if (layerControlContainer) {
                    controlsContainer.appendChild(layerControlContainer);
                }

                map.on("baselayerchange", function (e) {
                    if (activeLayer && e.layer !== activeLayer) {
                        map.removeLayer(activeLayer);
                    }
                    activeLayer = e.layer;
                });

                const firstLayerName = Object.keys(radioBaseMaps)[1];
                if (firstLayerName) {
                    radioBaseMaps[firstLayerName].addTo(map);
                    activeLayer = radioBaseMaps[firstLayerName];
                }
            });

            L.control.scale().addTo(map);
        </script>
    </body>
</html>